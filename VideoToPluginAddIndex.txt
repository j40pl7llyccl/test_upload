ğŸ”¹ ä¸»è¦ä¿®æ”¹é»
1. å¢åŠ  Index ä¾†è¿½è¹¤ç•¶å‰å½±æ ¼
åƒ uMProvidImageLoader.cs çš„ OpenImageIndex ä¸€æ¨£ï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹ æšèˆ‰ (enum) ä¾†å®šç¾© UDataCarrier å­˜æ”¾çš„æ•¸æ“šæ ¼å¼ï¼š

csharp
è¤‡è£½
ç·¨è¼¯
internal enum VideoFrameIndex : int
{
    VideoPath = 0,   // å½±ç‰‡è·¯å¾‘
    Interval,        // åˆ‡å‰²é–“éš” (ç§’)
    FrameRate,       // å½±ç‰‡å¹€ç‡
    TotalFrames,     // å½±ç‰‡ç¸½å½±æ ¼æ•¸
    CurrentIndex,    // ç•¶å‰å½±æ ¼ç´¢å¼•
    MaxAsCount       // é˜²æ­¢æ–°å¢è¶…å‡ºé€™å€‹ç¯„åœ
}
2. ä¿®æ”¹ MakeVideoToFrameInitDataï¼ŒåŠ å…¥ FrameRateã€TotalFrames å’Œ CurrentIndex
åŸæœ¬ MakeVideoToFrameInitData åªå­˜å½±ç‰‡è·¯å¾‘å’Œé–“éš”ç§’æ•¸ï¼Œä½†ç¾åœ¨éœ€è¦åˆå§‹åŒ– ç¸½å½±æ ¼æ•¸ (TotalFrames)ã€å¹€ç‡ (FrameRate) å’Œç•¶å‰ç´¢å¼• (CurrentIndex)ï¼š

csharp
è¤‡è£½
ç·¨è¼¯
public static UDataCarrier MakeVideoToFrameInitData(string videoPath, int intervalSeconds)
{
    if (!string.IsNullOrEmpty(videoPath) && System.IO.File.Exists(videoPath))
    {
        using (var reader = new Accord.Video.FFMPEG.VideoFileReader())
        {
            reader.Open(videoPath);
            double frameRate = reader.FrameRate.Value;   // å½±ç‰‡å¹€ç‡
            long totalFrames = reader.FrameCount;       // å½±ç‰‡ç¸½å½±æ ¼æ•¸
            reader.Close();

            object[] data = new object[(int)VideoFrameIndex.MaxAsCount];
            data[(int)VideoFrameIndex.VideoPath] = videoPath;
            data[(int)VideoFrameIndex.Interval] = intervalSeconds;
            data[(int)VideoFrameIndex.FrameRate] = frameRate;
            data[(int)VideoFrameIndex.TotalFrames] = totalFrames;
            data[(int)VideoFrameIndex.CurrentIndex] = 0;   // åˆå§‹ç´¢å¼•è¨­ç‚º 0

            return UDataCarrier.MakeOne(data, true);
        }
    }
    return null;
}
âœ… æ–°å¢çš„å…§å®¹

FrameRate: è¨˜éŒ„å½±ç‰‡çš„æ¯ç§’å½±æ ¼æ•¸ï¼Œå¹«åŠ©è¨ˆç®—è©²è®€å–å“ªå€‹å½±æ ¼ã€‚
TotalFrames: è¨˜éŒ„æ•´éƒ¨å½±ç‰‡æœ‰å¤šå°‘å½±æ ¼ï¼Œç¢ºä¿ä¸æœƒè¶…å‡ºç¯„åœã€‚
CurrentIndex: è¨˜éŒ„ç•¶å‰è™•ç†çš„å½±æ ¼ä½ç½®ï¼Œä¸¦ä¸” æ¯æ¬¡åŸ·è¡Œ Macro æ™‚éƒ½è¦æ›´æ–°ã€‚
3. ä¿®æ”¹ ExtractFramesï¼Œæ¯æ¬¡åªè™•ç†ã€Œç•¶å‰å½±æ ¼ã€ï¼Œç„¶å¾Œæ›´æ–° CurrentIndex
csharp
è¤‡è£½
ç·¨è¼¯
private UDataCarrier[] ExtractFrames(UMacro MacroInstance,
                                     UDataCarrier[] PrevPropagationCarrier,
                                     List<UMacroProduceCarrierResult> historyResultCarriers,
                                     List<UMacroProduceCarrierPropagation> historyPropagationCarriers,
                                     List<UMacroProduceCarrierDrawingResult> historyDrawingCarriers,
                                     List<UScriptHistoryCarrier> historyCarrier,
                                     ref bool bStatusCode, ref string strStatusMessage,
                                     ref UDataCarrier[] CurrPropagationCarrier,
                                     ref UDrawingCarriers CurrDrawingCarriers,
                                     ref fpUDataCarrierSetResHandler PropagationCarrierHandler,
                                     ref fpUDataCarrierSetResHandler ResultCarrierHandler)
{
    if (MacroInstance.MutableInitialData == null)
    {
        bStatusCode = false;
        strStatusMessage = "æœªé…ç½®åˆå§‹è³‡æ–™ã€‚";
        return null;
    }

    if (!(MacroInstance.MutableInitialData.Data is object[] data) || data.Length < (int)VideoFrameIndex.MaxAsCount)
    {
        bStatusCode = false;
        strStatusMessage = "åˆå§‹è³‡æ–™ç„¡æ•ˆã€‚";
        return null;
    }

    // âœ… å–å‡ºå½±ç‰‡è³‡è¨Š
    string videoPath = data[(int)VideoFrameIndex.VideoPath] as string;
    int intervalSeconds = Convert.ToInt32(data[(int)VideoFrameIndex.Interval]);
    double frameRate = Convert.ToDouble(data[(int)VideoFrameIndex.FrameRate]);
    long totalFrames = Convert.ToInt64(data[(int)VideoFrameIndex.TotalFrames]);
    long currentIndex = Convert.ToInt64(data[(int)VideoFrameIndex.CurrentIndex]);

    if (currentIndex >= totalFrames)
    {
        bStatusCode = false;
        strStatusMessage = "å·²é”å½±ç‰‡çµå°¾";
        return null;
    }

    string outputDir = System.IO.Path.Combine(System.IO.Path.GetDirectoryName(videoPath), "ExtractedFrames");
    if (!System.IO.Directory.Exists(outputDir))
        System.IO.Directory.CreateDirectory(outputDir);

    try
    {
        using (var reader = new Accord.Video.FFMPEG.VideoFileReader())
        {
            reader.Open(videoPath);
            long targetFrame = (long)(currentIndex); // å–ç•¶å‰å½±æ ¼
            reader.Seek(targetFrame);  // âœ… ç›´æ¥è·³åˆ°æŒ‡å®šå½±æ ¼
            Bitmap frame = reader.ReadVideoFrame();
            reader.Close();

            if (frame != null)
            {
                string fileName = System.IO.Path.Combine(outputDir, $"frame_{currentIndex:D5}.png");
                frame.Save(fileName, System.Drawing.Imaging.ImageFormat.Png);
                frame.Dispose();

                // âœ… æ›´æ–° `CurrentIndex`
                data[(int)VideoFrameIndex.CurrentIndex] = currentIndex + (long)(frameRate * intervalSeconds);
                
                // âœ… æŠŠè¼¸å‡ºçµæœå­˜å…¥ UDataCarrierï¼Œä¸¦å‚³éçµ¦ Macro
                bStatusCode = true;
                CurrPropagationCarrier = UDataCarrier.MakeVariableItemsArray(new string[] { fileName });
                return null;
            }
            else
            {
                bStatusCode = false;
                strStatusMessage = "ç„¡æ³•è®€å–å½±æ ¼";
                return null;
            }
        }
    }
    catch (Exception ex)
    {
        bStatusCode = false;
        strStatusMessage = "æå–éç¨‹ä¸­å‡ºç¾ä¾‹å¤–ï¼š" + ex.Message;
        return null;
    }
}
ğŸ”¹ ä¿®æ”¹å¾Œçš„é‹ä½œæ–¹å¼
æ­¥é©Ÿ	è¡Œç‚º
ç¬¬ä¸€æ¬¡åŸ·è¡Œ Macro	CurrentIndex = 0ï¼Œè®€å–ç¬¬ 0 å½±æ ¼ï¼Œå„²å­˜ frame_00000.png
ç¬¬äºŒæ¬¡åŸ·è¡Œ Macro	CurrentIndex += frameRate * intervalSecondsï¼Œè·³åˆ°ä¸‹ä¸€å€‹æŒ‡å®šå½±æ ¼
é‡è¤‡åŸ·è¡Œ	é€æ­¥å¾€å¾Œè®€å–ï¼Œç›´åˆ° CurrentIndex >= TotalFrames
è®€å–åˆ°å½±ç‰‡çµå°¾	åœæ­¢ï¼Œå›å‚³ "å·²é”å½±ç‰‡çµå°¾"